{% extends 'base.html' %}

{% block meta %}
<title>{{ collection.name }}</title>
<script>
let currentItemId = null;

function showMoveModal(itemId) {
    currentItemId = itemId;
    document.getElementById('moveItemModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('moveItemModal').classList.add('hidden');
    currentItemId = null;
}

function showAddToModal(itemId) {
    currentItemId = itemId;
    document.getElementById('addToModal').classList.remove('hidden');
}

function closeAddToModal() {
    document.getElementById('addToModal').classList.add('hidden');
    currentItemId = null;
}

function moveItem() {
    const targetCollectionId = document.getElementById('targetCollection').value;
    if (!targetCollectionId) return;

    fetch(`/wishlist/item/${currentItemId}/move/${targetCollectionId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.reload();
        } else {
            alert(data.message || 'Failed to move item');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to move item');
    });
}

function addToCollection() {
    const targetCollectionId = document.getElementById('targetCollectionForAdd').value;
    if (!targetCollectionId) return;

    fetch(`/wishlist/items/${currentItemId}/add-to/${targetCollectionId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.reload();
        } else {
            alert(data.message || 'Failed to add item to collection');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add item to collection');
    });
}

// function removeItem(itemId) {
//     if (!confirm('Are you sure you want to remove this item?')) return;

//     fetch(`/wishlist/item/${itemId}/remove/`, {
//         method: 'POST',
//         headers: {
//             'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
//         },
//     })
//     .then(response => response.json())
//     .then(data => {
//         if (data.status === 'success') {
//             const itemElement = document.getElementById(`item-${itemId}`);
//             if (itemElement) {
//                 itemElement.remove();
                
//                 // Check if there are no more items
//                 const itemsContainer = document.querySelector('.grid');
//                 if (!itemsContainer.querySelector('.border')) {
//                     itemsContainer.innerHTML = `
//                         <div class="col-span-full text-center py-8 text-gray-500 font-serif">
//                             No items in this collection yet.
//                         </div>
//                     `;
//                 }
//             }
//         } else {
//             alert(data.message || 'Failed to remove item');
//         }
//     })
//     .catch(error => {
//         console.error('Error:', error);
//         alert('Failed to remove item');
//     });
// }
function removeItem(itemId) {
    if (!confirm('Are you sure you want to remove this item?')) return;

    fetch(`/wishlist/item/${itemId}/remove/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const itemElement = document.getElementById(`item-${itemId}`);
            if (itemElement) {
                itemElement.remove();
                
                // Check if there are no more items
                const itemsContainer = document.querySelector('.grid');
                if (!itemsContainer.querySelector('.border')) {
                    itemsContainer.innerHTML = `
                        <div class="col-span-full text-center py-8 text-gray-500 font-serif">
                            No items in this collection yet.
                        </div>
                    `;
                }
            }
        } else {
            alert(data.message || 'Failed to remove item');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to remove item');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.move-item-btn').forEach(btn => {
        btn.addEventListener('click', () => showMoveModal(btn.dataset.itemId));
    });
    
    document.querySelectorAll('.add-to-btn').forEach(btn => {
        btn.addEventListener('click', () => showAddToModal(btn.dataset.itemId));
    });
});
</script>
{% endblock %}

{% block content %}
{% csrf_token %}

<div class="container mx-auto px-4 py-8">
    <!-- Back button -->
    <div class="mb-6">
        <a href="{% url 'wishlist:collection-list' %}" 
           class="inline-flex items-center text-gray-600 hover:text-black">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Back to Collections
        </a>
    </div>

    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-serif font-bold">{{ collection.name }}</h1>
            <div class="flex gap-4">
                {% if collection.name != "My Wishlist" %}
                <a href="{% url 'wishlist:collection-edit' collection.id %}" 
                   class="text-gray-600 hover:text-black">
                    Edit Collection
                </a>
                {% if not collection.is_default %}
                <form method="post" action="{% url 'wishlist:collection-delete' collection.id %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" 
                            class="text-red-600 hover:text-red-800"
                            onclick="return confirm('Are you sure you want to delete this collection?')">
                        Delete Collection
                    </button>
                </form>
                {% endif %}
                {% endif %}
            </div>
        </div>
        
        {% if collection.description %}
        <p class="text-gray-600 mb-6">{{ collection.description }}</p>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for item in collection.items.all %}
        <div class="border rounded-lg overflow-hidden bg-white shadow-sm hover:shadow transition-all">
            {% if item.menu_item.image %}
            <img src="{{ item.menu_item.image }}" alt="{{ item.menu_item.name }}" class="w-full h-48 object-cover">
            {% else %}
            <div class="w-full h-48 bg-gray-100 flex items-center justify-center">
                <span class="text-gray-400 font-serif">No image</span>
            </div>
            {% endif %}
            
            <div class="p-4">
                <h3 class="font-serif font-semibold text-lg mb-2">{{ item.menu_item.name }}</h3>
                <p class="text-gray-600 mb-4 text-sm">{{ item.menu_item.description|truncatewords:20 }}</p>
                <div class="flex justify-between items-center">
                    <span class="font-bold">Rp {{ item.menu_item.price }}</span>
                    <div class="flex gap-2">

                        <!-- untuk button di selain my wishlist -->
                        {% if collection.name != "My Wishlist" %}
                        <button type="button" 
                                class="text-gray-600 hover:text-black move-item-btn" 
                                data-item-id="{{ item.id }}">
                            Move
                        </button>
                        {% endif %}

                        <!-- untuk button Add to di collection -->
                        {% if collection.name == "My Wishlist" %}
                        <button type="button"
                                class="text-gray-600 hover:text-black add-to-btn"
                                data-item-id="{{ item.id }}">
                            Add to
                        </button>
                        {% endif %}
                        
                        <form method="post" action="{% url 'wishlist:item-remove' item.id %}" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="text-red-600 hover:text-red-800">
                                Remove
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-8 text-gray-500 font-serif">
            No items in this collection yet.
        </div>
        {% endfor %}
    </div>

    {% if collection.name != "My Wishlist" %}
    <!-- Move Item Modal -->
    <div id="moveItemModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h3 class="text-lg font-serif font-semibold mb-4">Move to Collection</h3>
            <select id="targetCollection" class="w-full p-2 border rounded mb-4">
                {% for other_collection in request.user.wishlist_collections.all %}
                    {% if other_collection != collection and other_collection.name != "My Wishlist" %}
                    <option value="{{ other_collection.id }}">{{ other_collection.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <div class="flex justify-end gap-4">
                <button type="button" onclick="closeModal()" class="text-gray-500 hover:text-black">Cancel</button>
                <button type="button" onclick="moveItem()" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800">Move</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Add to Modal -->
    <div id="addToModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h3 class="text-lg font-serif font-semibold mb-4">Add to Collection</h3>
            <select id="targetCollectionForAdd" class="w-full p-2 border rounded mb-4">
                {% for other_collection in request.user.wishlist_collections.all %}
                    {% if other_collection != collection and not other_collection.is_default %}
                    <option value="{{ other_collection.id }}">{{ other_collection.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <div class="flex justify-end gap-4">
                <button type="button" onclick="closeAddToModal()" class="text-gray-500 hover:text-black">Cancel</button>
                <button type="button" onclick="addToCollection()" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800">Add</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}