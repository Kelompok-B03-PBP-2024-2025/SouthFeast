{% extends 'base.html' %}

{% block title %}{{ question.title }}{% endblock %}

{% block content %}
    <div class="container mx-auto px-4 py-8">
        <h1>{{ question.title }}</h1>
        <p>{{ question.question }}</p>

        <!-- Edit/Delete buttons for the owner of the question -->
        {% if request.user == question.user %}
        <div class="button-group">
            <button class="btn-edit" onclick="openModal()">Edit</button>
            <a href="{% url 'forum:delete_question' question.id %}" onclick="return confirm('Are you sure you want to delete this question?');" class="btn-delete">Delete</a>
        </div>
        {% endif %}

        <h3>Answers</h3>
        <div class="answer-box">
            <!-- Display answers if there are any -->
            {% if answers %}
                {% for answer in answers %}
                    <div class="answer">
                        <p><strong>{{ answer.user.username }}:</strong> {{ answer.content }}</p>
                        <p>{{ answer.created_at }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <p>No answers yet.</p>
            {% endif %}
        </div>

        <!-- Form to submit a new answer -->
        <form method="POST">
            {% csrf_token %}
            {{ answer_form.as_p }}
            <button type="submit">Submit Answer</button>
        </form>

        <!-- Back to question list button -->
        <a href="{% url 'forum:show_main' %}" class="back-to-qna">Back to Questions</a>

        <!-- Modal for Edit Question -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Edit Question</h2>
                <form method="POST" id="editQuestionForm" action="{% url 'forum:edit_question' question.id %}">
                    {% csrf_token %}
                    <label for="title">Title</label>
                    <input type="text" name="title" id="title" value="{{ question.title }}" class="border border-gray-300 p-2 w-full rounded mb-4">

                    <label for="question">Question</label>
                    <textarea name="question" id="question" class="border border-gray-300 p-2 w-full rounded mb-4" style="width: 100%; height: 150px;">{{ question.question }}</textarea>

                    <div class="flex justify-end">
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button>
                        <button type="button" class="ml-2 bg-gray-500 text-white px-4 py-2 rounded" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            function openModal() {
                document.getElementById('editModal').style.display = 'flex';
            }

            function closeModal() {
                document.getElementById('editModal').style.display = 'none';
            }

            // AJAX form submission for editing question
            document.getElementById('editQuestionForm').onsubmit = function(event) {
                event.preventDefault();
                let formData = new FormData(this);
                fetch("{% url 'forum:edit_question' question.id %}", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeModal();
                        document.querySelector('h1').innerText = data.title;
                        document.querySelector('p').innerText = data.question;
                    } else {
                        alert("Failed to update question.");
                    }
                });
            };
        </script>
    </div>
{% endblock %}
